#!/usr/bin/env perl

use strict;
use warnings;

use Dancer ':syntax';
use Getopt::Long;
use YAML;

my %options = (
    'config'    => 'commentary.yml',
    'sitedir'   => '_site',
);

GetOptions(\%options,
    'config|c=s',
    'sitedir|s=s',
);

if (!-e $options{config}) {
    print STDERR "Configuration file '$options{config}' not found\n";
    exit 1;
}

my $config;
eval {
    $config = YAML::LoadFile($options{config});
    1;
}
or do {
    print STDERR "Couldn't load configuration file '$options{config}'\n";
    exit 1;
};

$ENV{DANCER_PUBLIC} = $options{sitedir};

Dancer->import;

Dancer::Config->load;

if (exists $config->{auth}) {
    # Pass auth configuration settings to Dancer::Plugin::Commentary
    config->{plugins}{Commentary}{auth} = {
        %{ config->{plugins}{Commentary}{auth} || {} },
        %{ $config->{auth} },
    };
}

config->{plugins}{Commentary}{stylesheets} = [
    '/app-commentary/assets/css/jekyll/jekyll.css'
];

# FIXME: Get rid of this
Dancer::set logger => 'console';
Dancer::set show_errors => 1;
Dancer::set session => 'Simple';

Dancer::load_app 'App::Commentary';

Dancer::dance;
